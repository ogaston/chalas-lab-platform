services:
  # PostgreSQL + pgvector (shared database)
  platform-postgres:
    image: pgvector/pgvector:pg16
    container_name: platform-postgres
    restart: unless-stopped
    environment:
      POSTGRES_USER: ${POSTGRES_USER:-postgres}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-postgres}
      POSTGRES_DB: ${POSTGRES_DB:-platform_dev}
    ports:
      - "${POSTGRES_PORT:-5432}:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U $$POSTGRES_USER"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - proxy

  # Redis (shared cache & queues)
  platform-redis:
    image: redis:7-alpine
    container_name: platform-redis
    restart: unless-stopped
    ports:
      - "${REDIS_PORT:-6379}:6379"
    volumes:
      - redis_data:/data
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - proxy

  # Meilisearch (shared search engine)
  platform-search:
    image: getmeili/meilisearch:v1.5
    container_name: platform-search
    restart: unless-stopped
    env_file:
      - stack.env
    environment:
      MEILI_ENV: production
    ports:
      - "${MEILISEARCH_PORT:-7700}:7700"
    volumes:
      - meilisearch_data:/meili_data
    networks:
      - proxy

  # MinIO (shared object storage)
  platform-objects:
    image: minio/minio:latest
    container_name: platform-objects
    restart: unless-stopped
    env_file:
      - stack.env
    environment:
      MINIO_ROOT_USER: ${MINIO_ROOT_USER}
      MINIO_ROOT_PASSWORD: ${MINIO_ROOT_PASSWORD}
      # reverse-proxy aware URLs
      MINIO_SERVER_URL: https://${MINIO_DOMAIN}
      MINIO_BROWSER_REDIRECT_URL: https://${MINIO_CONSOLE_DOMAIN}
    labels:
      - traefik.enable=true
      - traefik.docker.network=proxy
    
      # S3 API (port 9000)
      - traefik.http.routers.platform-objects.rule=Host(`${MINIO_DOMAIN}`)
      - traefik.http.routers.platform-objects.entrypoints=web
      - traefik.http.routers.platform-objects.service=platform-objects-s3
      - traefik.http.services.platform-objects-s3.loadbalancer.server.port=9000
    
      # Console UI (port 9001)
      - traefik.http.routers.platform-objects-console.rule=Host(`${MINIO_CONSOLE_DOMAIN}`)
      - traefik.http.routers.platform-objects-console.entrypoints=web
      - traefik.http.routers.platform-objects-console.service=platform-objects-console
      - traefik.http.services.platform-objects-console.loadbalancer.server.port=9001
    volumes:
      - minio_data:/data
    networks:
      - proxy
    command: server /data --console-address ":9001"
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:9000/minio/health/live"]
      interval: 10s
      timeout: 5s
      retries: 5

  # MinIO bootstrap (bucket + public policy)
  platform-objects-init:
    image: minio/mc:latest
    container_name: platform-objects-init
    env_file:
      - stack.env
    depends_on:
      platform-objects:
        condition: service_healthy
    networks:
      - proxy
    entrypoint: >
      /bin/sh -ec "
      echo 'Waiting for MinIO...';
      sleep 3;
      mc alias set platform http://platform-objects:9000 $MINIO_ROOT_USER $MINIO_ROOT_PASSWORD;
      mc mb platform/${PUBLIC_BUCKET_NAME:-uploads} --ignore-existing;
      mc anonymous set download platform/${PUBLIC_BUCKET_NAME:-uploads};
      echo 'Bucket ready: ${PUBLIC_BUCKET_NAME:-uploads}';
      exit 0;
      "

  # SMTP (MailHog)
  platform-mail:
    image: mailhog/mailhog:v1.0.1
    container_name: platform-mail
    restart: unless-stopped
    ports:
      - "${MAIL_SMTP_PORT:-1025}:1025"
    labels:
      - traefik.enable=true
      - traefik.docker.network=proxy
      - traefik.http.routers.platform-mail.rule=Host(`${MAIL_UI_DOMAIN:-mailhog}`)
      - traefik.http.routers.platform-mail.entrypoints=web
      - traefik.http.services.platform-mail.loadbalancer.server.port=8025
    networks:
      - proxy

  platform-tunnel:
    image: cloudflare/cloudflared:latest
    container_name: platform-tunnel
    restart: unless-stopped
    command: tunnel run
    environment:
      - TUNNEL_TOKEN=${CLOUDFLARED_TOKEN}
    networks:
      - proxy

volumes:
  postgres_data:
    driver: local
  redis_data:
    driver: local
  meilisearch_data:
    driver: local
  minio_data:
    driver: local

networks:
  proxy:
    external: true
